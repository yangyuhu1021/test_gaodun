<extend name="Public:base"/>

<block name="body">
    <style type="text/css">
        * {
            list-style: none;
        }

        #body {

            width: 95%;

            background: white;

            border-radius: 10px;

            margin: 2.5%;

            position: relative;

        }

        .add_button {
            margin: 20px 30px;
            height: 40px;
            width: 80px;
        }

        .top_input_button {

            width: 300px;

            height: 42px;

        }

        .btn-default {

            color: #fff;

            background-image: none;

            background-color: rgba(255, 150, 47, 1);

            border: none;

        }

        .btn-default:focus, .btn-default:hover {

            color: #fff;

            background-image: none;

            border: none;

            background-color: rgba(255, 150, 47, 1);

        }

        tr > td > span {

            margin: 5px;

            color: #00aaee;

        }

        thead > tr > th {

            text-align: center;

        }

        #data_tr > td {

            text-align: center;

        }

        form ul > li {
            margin: 10px;
        }

        #table_form > div {
            padding: 10px;
        }

        .file-box {
            display: inline-block;
            position: relative;
            top: 15px;
            padding: 3px 5px;
            overflow: hidden;
            border: solid 1px #ccc;
            border-radius: 8px;
        }

        .file-btn {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 15px;
            left: 0;
            outline: none;
            background-color: transparent;
            filter: alpha(opacity=0);
            -moz-opacity: 0;
            -khtml-opacity: 0;
            opacity: 0;
        }


    </style>
    <div id="body">

        <button type="button" data-toggle="modal" data-target="#myModal" class="btn btn-default add_button ">添加</button>

        <!-- 模态框（Modal） -->

        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">

            <div class="modal-dialog">

                <div class="modal-content">

                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel">添加</h4>
                    </div>
                    <div class="modal-body">
                        <form id="table_form" action="" enctype="multipart/form-data" onsubmit="return false">

                            <div class="input-group input-group-lg">
                                <span class="input-group-addon"><span style="color: red">*</span>活动名称</span>
                                <input type="text" class="form-control" id="name" aria-describedby="sizing-addon1">
                            </div>
                            <div class="input-group input-group-lg">
                                <span class="input-group-addon"><span style="color: red">*</span>活动时间</span>
                                <input type="text" class="form-control" id="time" aria-describedby="sizing-addon1">
                                <span class="input-group-addon">小时</span>
                            </div>
                            &nbsp;&nbsp;<span><span style="color: red">*</span>活动封面:</span>
                            <div class="file-box">
                                <input type="file" id="cove_img" class="file-btn"/>
                                选择上传文件
                            </div>
                            <img id="cove" src="" width="200px">
                            <div style="color: red">支持jpg/png，图片建议大小750*264px，不超过1M</div>
                            <div class="input-group input-group-lg" style="margin-top: 20px;">
                                <span class="input-group-addon" id="sizing-addon1"><span
                                        style="color: red">*</span>原价</span>
                                <input type="text" class="form-control" id="price" aria-describedby="sizing-addon1">
                            </div>

                            &nbsp;&nbsp;<span><span style="color: red">*</span>简介图片:</span>
                            <div class="file-box">
                                <input type="file" id="load_file" class="file-btn"/>
                                选择上传文件
                            </div>
                            <img id="img" src="" width="200px">
                            <div style="color: red">支持jpg/png，图片建议大小750*264px，不超过1M</div>
                            <br><br>

                            &nbsp;&nbsp;<span style="color: red">*</span>模式： <input type="radio" name="pattern"
                                                                                    value="1" checked>获取手机号

                            <div class="add_chapter">
                                <div class="hour">
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-addon"><span style="color: red">*</span>视频章节名称</span>
                                        <input type="text" class="form-control chapter"
                                               aria-describedby="sizing-addon1">
                                        <span class="input-group-addon" onclick="add_hour(this,1)">+课时</span>
                                    </div>
                                    <br/>
                                    <div class="hour_div">
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-addon"><span style="color: red">*</span>课时名称</span>
                                            <input type="text" class="form-control hour_name1"
                                                   aria-describedby="sizing-addon1">
                                            <span class="input-group-addon" onclick="del_hour(this)">删除课时</span>
                                        </div>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-addon"><span style="color: red">*</span>课时链接</span>
                                            <input type="text" class="form-control hour_url1"
                                                   aria-describedby="sizing-addon1">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p style="text-align: center">
                                <button type="button" id="add_chapter" class="btn add_button ">加章节</button>
                                <button type="button" id="del_chapter" class="btn add_button ">删除章节</button>
                            </p>
                            <p style="text-align: center">
                                <button type="button" data-dismiss="modal" class="btn add_button ">取消</button>
                                <button type="button" id="add_but" class="btn btn-default add_button ">添加</button>
                            </p>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div style="position: absolute;right: 115px;top:20px">
            <input type="text" id="like_code" class="form-control top_input_button" placeholder="请输入活动项目名称"
                   aria-describedby="sizing-addon1">
        </div>

        <div style="position: absolute;right: 20px;top:0">
            <button type="button" id="like" class="btn btn-default  add_button" style="width: 60px">查询</button>
        </div>

        <ul class="nav nav-tabs" style="margin: 30px;">
            <li role="presentation"><a href="{:U('project/data')}">资料列表</a></li>
            <li role="presentation" class="active"><a href="#">视频列表</a></li>
            <li role="presentation"><a href="{:U('project/advertise')}">广告列表</a></li>
            <li role="presentation"><a href="{:U('project/recycle')}">回收站</a></li>
        </ul>

        <div class="row" style="margin-left: 15px;width: 97%">
            <form id="form" method="post" action="" onsubmit="return false">
                <div class="col-xs-12">
                    <table class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th class="center"><input class="check-all" type="checkbox" value=""></th>
                            <th>编号</th>
                            <th>活动名称</th>
                            <th>活动时间（h）</th>
                            <th>模式</th>
                            <th>发布时间</th>
                            <th>状态</th>
                            <th>参与总人数</th>
                            <th>操作</th>
                        </tr>
                        </thead>

                        <tbody>

                        <volist name="data" id="vo">
                            <tr id="data_tr" style="overflow: hidden">
                                <td class="center">
                                    <input class="uids" type="checkbox" name="uids[]" value="{$vo.id}">
                                </td>
                                <td>{$vo.id}</td>
                                <td>{$vo.name}</td>
                                <td>{$vo.ontime}</td>
                                <td>{$vo.pattern}</td>
                                <td>{$vo.time}</td>
                                <td>{$vo.type}</td>
                                <td>{$vo.user}</td>
                                <td>
                                    <span onclick="group_table('{$vo.id}','edit')">编辑</span>
                                    <span onclick="group_table('{$vo.id}','auth')">参与人员列表</span>
                                    <span onclick="group_table('{$vo.id}','del')">删除 </span>
                                </td>
                            </tr>
                        </volist>
                        </tbody>
                    </table>
                    <button type="button" id="submit" class="btn add_button" style="width: 60px">删除</button>
                    {$page}
                    <!-- PAGE CONTENT ENDS -->
                </div><!-- /.col -->
            </form>
        </div>
    </div>
    <script>
        var cover_img = '';
        var load_file = '';
        var fileCover = document.querySelector("#cove_img");
        var loadFile = document.querySelector("#load_file");
        var a = 1;
        $("#cove_img").on("change", function () {
            upload(fileCover, 1);
        });
        $("#load_file").on("change", function () {
            upload(loadFile, 2);
        });

        function upload(file, key) {
            var fileObj = file.files[0];
            var formData = new FormData();
            formData.append('file', fileObj);
            $.ajax({
                url: 'upload',
                type: 'post',
                contentType: false,
                data: formData,
                processData: false,
                success: function (res) {
                    if (res.code) {
                        if (key === 1) {
                            cover_img = res.url;
                            $('#cove').attr('src', '/' + cover_img);
                        } else if (key === 2) {
                            load_file = res.url;
                            $('#img').attr('src', '/' + load_file);
                        }
                    } else {
                        bootbox.alert({title: "系统提示", message: res.msg});
                    }
                }
            });
        }

        function add_hour(res, i) {
            $(res).parent().parent().append('<div class="hour_div" style="margin-top: 10px;">' +
                '<div class="input-group input-group-lg">' +
                '<span class="input-group-addon"><span style="color: red">*</span>课时名称</span>' +
                '<input type="text" class="form-control hour_name' + i + '" aria-describedby="sizing-addon1">' +
                '<span class="input-group-addon" onclick="del_hour(this)">删除课时</span>' +
                '</div>' +
                '<div class="input-group input-group-lg">' +
                '<span class="input-group-addon"><span style="color: red">*</span>课时链接</span>' +
                '<input type="text" class="form-control hour_url' + i + '" aria-describedby="sizing-addon1">' +
                '</div>' +
                '</div>');
        }

        function del_hour(res) {
            $(res).parent().parent().remove();
        }

        $('#add_chapter').click(function () {
            a++;
            $('.add_chapter').append('<div class="hour" style="margin-top: 20px;">' +
                '<div class="input-group input-group-lg">' +
                '<span class="input-group-addon"><span style="color: red">*</span>视频章节名称</span>' +
                '<input type="text" class="form-control chapter" aria-describedby="sizing-addon1">' +
                '<span class="input-group-addon" onclick="add_hour(this,a)">+课时</span>' +
                '</div>' +
                '<br/>' +
                '<div class="hour_div">' +
                '<div class="input-group input-group-lg">' +
                '<span class="input-group-addon"><span style="color: red">*</span>课时名称</span>' +
                '<input type="text" class="form-control hour_name' + a + '" aria-describedby="sizing-addon1">' +
                '<span class="input-group-addon" onclick="del_hour(this)">删除课时</span>' +
                '</div>' +
                '<div class="input-group input-group-lg">' +
                '<span class="input-group-addon"><span style="color: red">*</span>课时链接</span>' +
                '<input type="text" class="form-control hour_url' + a + '" aria-describedby="sizing-addon1">' +
                '</div>' +
                '</div>' +
                '</div>');
        });
        $('#del_chapter').click(function () {
            a--;
            $('.hour:last').remove();
        });

        $('#add_but').click(function () {
            var hour = "";
            var hoururl = "";
            var chapter = "";
            $(".chapter").each(function () {
                chapter += $(this).val() + ",";
            });
            for (i = 1; i < (a + 1); i++) {
                $(".hour_name" + i).each(function () {
                    hour += $(this).val() + ",";
                });
                hour += '|';
                $(".hour_url" + i).each(function () {
                    hoururl += $(this).val() + ",";
                });
                hoururl += '|';
            }
            console.log(chapter);
            console.log(hour);
            console.log(hoururl);
            var name = $('#name').val();
            var time = $('#time').val();
            var price = $('#price').val();
            var pattern = $("input[name='pattern']:checked").val();
            if (name !== '' && time !== '' && price !== '' && chapter !== '' && pattern !== '' && hour !== '' && hoururl !== '' && cover_img !== '' && load_file !== '') {
                $.post('video', {
                    name: name,
                    ontime: time,
                    price: price,
                    chapter: chapter,
                    pattern: pattern,
                    hour: hour,
                    hoururl: hoururl,
                    cover: cover_img,
                    fileurl: load_file,
                    key: 'add'
                }, function (res) {
                    if (res.code) {
                        bootbox.alert({title: "系统提示", message: res.msg});
                        setTimeout(function () {
                            location.reload();
                        }, 2000)
                    } else {
                        bootbox.alert({title: "系统提示", message: res.msg});
                    }
                })
            } else {
                bootbox.alert({title: "系统提示", message: '请填入完整的信息'});
            }
        });
        $(".check-all").click(function () {
            $(".uids").prop("checked", this.checked);
        });
        $(".uids").click(function () {
            var option = $(".ids");
            option.each(function (i) {
                if (!this.checked) {
                    $(".check-all").prop("checked", false);
                    return false;
                } else {
                    $(".check-all").prop("checked", true);
                }
            });
        });
        $("#submit").click(function () {
            bootbox.dialog({
                message: '是否删除所选项目',
                title: "系统提示",
                buttons: {
                    success: {
                        label: "关闭",
                        className: "btn-danger",
                        callback: function () {
                        }
                    },
                    "Danger": {
                        label: "删除",
                        className: "btn-success",
                        callback: function () {
                            arr = [];
                            $.each($('.uids:checkbox'), function () {
                                if (this.checked) {
                                    arr.push($(this).val());
                                }
                            });
                            str = arr.join(',');
                            if (arr.length > 0) {
                                $.post('video', {id: str, key: 'dels'}, function (res) {
                                    if (res.code) {
                                        bootbox.alert({title: "系统提示", message: res.msg});
                                        setTimeout(function () {
                                            location.reload();
                                        }, 2000)
                                    } else {
                                        bootbox.alert({title: "系统提示", message: res.msg});
                                    }
                                })
                            }
                        }
                    }
                }
            });
        });

        function edit_add_hour(res, i) {
            $(res).parent().parent().append('' +
                '<div class="edit_hour_div" style="margin-top: 10px;">' +
                '<div class="input-group input-group-lg">' +
                '<span class="input-group-addon"><span style="color: red">*</span>课时名称</span>' +
                '<input type="text" class="form-control edit_hour_name' + i + '" aria-describedby="sizing-addon1">' +
                '<span class="input-group-addon" onclick="edit_del_hour(this)">删除课时</span>' +
                '</div>' +
                '<div class="input-group input-group-lg">' +
                '<span class="input-group-addon"><span style="color: red">*</span>课时链接</span>' +
                '<input type="text" class="form-control edit_hour_url' + i + '" aria-describedby="sizing-addon1">' +
                '</div>' +
                '</div>');
        }

        function edit_del_hour(res) {
            $(res).parent().parent().remove();
        }

        function group_table(id, event) {
            if (event === 'edit') {
                $.post('video', {id: id, key: 'select'}, function (res) {
                    bootbox.dialog({
                        message: '' +
                            '<form id="table_form" action="" enctype="multipart/form-data" onsubmit="return false">' +
                            '<div class="input-group input-group-lg">' +
                            '<span class="input-group-addon"><span style="color: red">*</span>活动名称</span>' +
                            '<input type="text" class="form-control" id="edit_name" value="' + res.name + '" aria-describedby="sizing-addon1">' +
                            '</div>' +
                            '<div class="input-group input-group-lg">' +
                            '<span class="input-group-addon"><span style="color: red">*</span>活动时间</span>' +
                            '<input type="text" class="form-control" id="edit_time" value="' + res.ontime + '"  aria-describedby="sizing-addon1">' +
                            '<span class="input-group-addon">小时</span>' +
                            '</div>' +
                            '&nbsp;&nbsp;<span><span style="color: red">*</span>活动封面:</span>' +
                            '<div class="file-box"><input type="file" id="edit_cove_img" class="file-btn"/>选择上传文件</div>' +
                            '<img id="edit_cove" src="/' + res.cover + '" width="200px">' +
                            '<div style="color: red">支持jpg/png，图片建议大小750*264px，不超过1M</div>' +
                            '<div class="input-group input-group-lg" style="margin-top: 20px;">' +
                            '<span class="input-group-addon" id="sizing-addon1"><span style="color: red">*</span>原价</span>' +
                            '<input type="text" class="form-control" id="edit_price" value="' + res.price + '"  aria-describedby="sizing-addon1">' +
                            '</div>' +
                            '&nbsp;&nbsp;<span><span style="color: red">*</span>简介图片:</span>' +
                            '<div class="file-box"><input type="file" id="edit_load_file" class="file-btn"/>选择上传文件</div>' +
                            '<img id="edit_img" src="/' + res.fileurl + '" width="200px"><br><br>' +
                            '<div style="color: red">支持jpg/png，图片建议大小750*264px，不超过1M</div>' +
                            '&nbsp;&nbsp;<span style="color: red">*</span>模式： <input type="radio" name="edit_pattern" value="1" checked>获取手机号' +
                            '<div class="edit_add_chapter">' +
                            '</div>' +
                            '<p style="text-align: center">' +
                            '<button type="button" id="edit_add_chapter" class="btn edit_add_button ">加章节</button>' +
                            '<button type="button" id="edit_del_chapter" class="btn edit_add_button ">删除章节</button>' +
                            '</p>' +
                            '</form>',
                        title: "编辑",
                        buttons: {
                            success: {
                                label: "关闭",
                                className: "btn-danger",
                                callback: function () {
                                }
                            },
                            "Danger": {
                                label: "确认",
                                className: "btn-success",
                                callback: function () {
                                    edit()
                                }
                            }
                        }
                    });
                    var cover_img = '';
                    var load_file = '';
                    var b = '';
                    var fileCover = document.querySelector("#edit_cove_img");
                    var loadFile = document.querySelector("#edit_load_file");

                    $("#edit_cove_img").on("change", function () {
                        upload(fileCover, 1);
                    });
                    $("#edit_load_file").on("change", function () {
                        upload(loadFile, 2);
                    });

                    function upload(file, key) {
                        var fileObj = file.files[0];
                        var formData = new FormData();
                        formData.append('file', fileObj);
                        $.ajax({
                            url: 'upload',
                            type: 'post',
                            contentType: false,
                            data: formData,
                            processData: false,
                            success: function (res) {
                                if (res.code) {
                                    if (key === 1) {
                                        cover_img = res.url;
                                        $('#edit_cove').attr('src', '/' + cover_img);
                                    } else if (key === 2) {
                                        load_file = res.url;
                                        $('#edit_img').attr('src', '/' + load_file);
                                    }
                                } else {
                                    bootbox.alert({title: "系统提示", message: res.msg});
                                }
                            }
                        });
                    }

                    $(function () {
                        chapter = res.chapter.split(',');
                        hour = res.hour.split("|");
                        hoururl = res.hoururl.split("|");
                        for (i = 0; i < chapter.length; i++) {
                            if (chapter[i] !== '') {
                                $('.edit_add_chapter').append('<div class="edit_hour">' +
                                    '<div class="input-group input-group-lg" style="margin-top: 10px;">' +
                                    '<span class="input-group-addon"><span style="color: red">*</span>视频章节名称</span>' +
                                    '<input type="text" class="form-control edit_chapter" value="' + chapter[i] + '" aria-describedby="sizing-addon1">' +
                                    '<span class="input-group-addon"  onclick="edit_add_hour(this,' + (i + 1) + ')">+课时</span>' +
                                    '</div><br/>' +
                                    '</div>');
                                huorArr = hour[i].split(",");
                                hourUrlArr = hoururl[i].split(",");
                                for (j = 0; j < huorArr.length; j++) {
                                    if (huorArr[j] !== '') {
                                        $('.edit_hour:last').append(
                                            '<div class="hour_div">' +
                                            '<div class="input-group input-group-lg">' +
                                            '<span class="input-group-addon"><span style="color: red">*</span>课时名称</span>' +
                                            '<input type="text" class="form-control edit_hour_name' + (i + 1) + '" value="' + huorArr[j] + '" aria-describedby="sizing-addon1">' +
                                            '<span class="input-group-addon" onclick="edit_del_hour(this)">删除课时</span>' +
                                            '</div>' +
                                            '<div class="input-group input-group-lg">' +
                                            '<span class="input-group-addon"><span style="color: red">*</span>课时链接</span>' +
                                            '<input type="text" class="form-control edit_hour_url' + (i + 1) + '" value="' + hourUrlArr[j] + '" aria-describedby="sizing-addon1">' +
                                            '</div>' +
                                            '</div>');
                                    }
                                }
                            }
                            b = i + 1;
                        }

                    });

                    $('#edit_add_chapter').click(function () {
                        b++;
                        $('.edit_add_chapter').append('' +
                            '<div class="edit_hour" style="margin-top: 20px;">' +
                            '<div class="input-group input-group-lg">' +
                            '<span class="input-group-addon"><span style="color: red">*</span>视频章节名称</span>' +
                            '<input type="text" class="form-control edit_chapter" aria-describedby="sizing-addon1">' +
                            '<span class="input-group-addon" onclick="edit_add_hour(this,' + b + ')">+课时</span>' +
                            '</div><br/>' +
                            '<div class="edit_hour_div">' +
                            '<div class="input-group input-group-lg">' +
                            '<span class="input-group-addon"><span style="color: red">*</span>课时名称</span>' +
                            '<input type="text" class="form-control edit_hour_name' + b + '" aria-describedby="sizing-addon1">' +
                            '<span class="input-group-addon" onclick="edit_del_hour(this)">删除课时</span>' +
                            '</div>' +
                            '<div class="input-group input-group-lg">' +
                            '<span class="input-group-addon"><span style="color: red">*</span>课时链接</span>' +
                            '<input type="text" class="form-control edit_hour_url' + b + '" aria-describedby="sizing-addon1">' +
                            '</div>' +
                            '</div>' +
                            '</div>');
                    });
                    $('#edit_del_chapter').click(function () {
                        b--;
                        $('.edit_hour:last').remove();
                    });

                    function edit() {
                        var hour = "";
                        var hoururl = "";
                        var chapter = '';
                        $(".edit_chapter").each(function () {
                            chapter += $(this).val() + ",";
                        });
                        for (i = 1; i < (b + 1); i++) {
                            $(".edit_hour_name" + i).each(function () {
                                hour += $(this).val() + ",";
                            });
                            hour += '|';
                            $(".edit_hour_url" + i).each(function () {
                                hoururl += $(this).val() + ",";
                            });
                            hoururl += '|';
                        }

                        var name = $('#edit_name').val();
                        var time = $('#edit_time').val();
                        var price = $('#edit_price').val();
                        var pattern = $("input[name='edit_pattern']:checked").val();
                        if (name !== '' && time !== '' && price !== '' && chapter !== '' && pattern !== '' && hour !== '' && hoururl !== '') {
                            $.post('video', {
                                name: name,
                                ontime: time,
                                price: price,
                                chapter: chapter,
                                pattern: pattern,
                                hour: hour,
                                hoururl: hoururl,
                                cover: cover_img,
                                fileurl: load_file,
                                key: 'edit',
                                id: res.id
                            }, function (res) {
                                if (res.code) {
                                    bootbox.alert({title: "系统提示", message: res.msg});
                                    setTimeout(function () {
                                        location.reload();
                                    }, 2000)
                                } else {
                                    bootbox.alert({title: "系统提示", message: res.msg});
                                }
                            })
                        } else {
                            bootbox.alert({title: "系统提示", message: '请填入完整的信息'});
                        }
                    }
                });

            } else if (event === 'auth') {
                window.location.href = "user_list.html?id=" + id + '&type=2';
            } else if (event === 'del') {
                $.post('video', {id: id, key: 'del'}, function (res) {
                    if (res.code) {
                        bootbox.alert({title: "系统提示", message: res.msg});
                        setTimeout(function () {
                            location.reload();
                        }, 2000)
                    } else {
                        bootbox.alert({title: "系统提示", message: res.msg});
                    }
                })
            }

        }

        $('#like').click(function () {

            like = $('#like_code').val();

            window.location.href = '{:U("Dxadmin/project/video")}?like=' + like;

        })

    </script>

</block>